// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  role          UserRole  @default(MENTEE)
  department    String? // Khoa
  major         String? // Chuyên ngành
  year          Int? // Năm học (cho sinh viên)
  bio           String? // Giới thiệu
  achievements  String[] // Thành tích

  // Mentor specific fields
  mentorProfile MentorProfile?

  // Connection relationships
  // As a mentee
  menteeConnections MenteeConnection[] @relation("AsMentee")
  // As a mentor
  mentorConnections MenteeConnection[] @relation("AsMentor")

  // Social features
  posts     Post[]
  comments  Comment[]
  reactions Reaction[]

  // Reviews (back-relations) — PHẢI trùng tên relation với bên Review
  givenReviews    Review[] @relation("ReviewReviewer") // reviews user đã viết
  receivedReviews Review[] @relation("ReviewMentor")   // reviews user nhận được

  // MentorFeedback (back-relations) — PHẢI trùng tên relation với bên MentorFeedback
  mentorFeedbacksAsMentor  MentorFeedback[] @relation("FeedbackByMentor")
  mentorFeedbacksAsMentee  MentorFeedback[] @relation("FeedbackForMentee")

  // Chat features
  ownedServers    ChatServer[]   @relation("ServerOwner")
  memberOfServers ServerMember[]
  messages        Message[]
  // Server invitations
  receivedInvitations ServerInvitation[] @relation("InvitedUser")
  sentInvitations     ServerInvitation[] @relation("InvitedBy")

  recordings Recording[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MentorProfile {
  id            String   @id @default(cuid())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String   @unique
  rating        Float    @default(0)
  totalReviews  Int      @default(0)
  expertise     String[] // Các lĩnh vực chuyên môn
  maxMentees    Int      @default(5)
  availableDays String[] // Các ngày có thể dạy

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MenteeConnection {
  id       String           @id @default(cuid())
  mentee   User             @relation("AsMentee", fields: [menteeId], references: [id])
  menteeId String
  mentor   User             @relation("AsMentor", fields: [mentorId], references: [id])
  mentorId String
  status   ConnectionStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([menteeId, mentorId])
}

model Post {
  id        String     @id @default(cuid())
  content   String     @db.Text
  images    String[]
  published Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  author    User       @relation(fields: [authorId], references: [id])
  authorId  String
  comments  Comment[]
  reactions Reaction[]
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String
  author    User     @relation(fields: [authorId], references: [id])
  authorId  String
}

model Reaction {
  id        String       @id @default(cuid())
  type      ReactionType
  post      Post         @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String
  user      User         @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime     @default(now())

  @@unique([postId, userId])
}

model Review {
  id         String   @id @default(cuid())

  reviewer   User     @relation("ReviewReviewer", fields: [reviewerId], references: [id])
  reviewerId String

  mentor     User     @relation("ReviewMentor", fields: [mentorId], references: [id])
  mentorId   String

  rating     Int
  comment    String?
  createdAt  DateTime @default(now())

  @@index([mentorId])
}

model MentorFeedback {
  id        String   @id @default(cuid())
  mentor    User     @relation("FeedbackByMentor", fields: [mentorId], references: [id])
  mentorId  String
  mentee    User     @relation("FeedbackForMentee", fields: [menteeId], references: [id])
  menteeId  String
  score     Int?
  comment   String?
  createdAt DateTime @default(now())

  @@index([mentorId])
  @@index([menteeId])
}

// Chat Models
model ChatServer {
  id          String         @id @default(cuid())
  name        String
  description String?
  image       String?
  owner       User           @relation("ServerOwner", fields: [ownerId], references: [id])
  ownerId     String
  members     ServerMember[]
  channels    Channel[]
  invitations ServerInvitation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ServerInvitation {
  id        String     @id @default(cuid())
  server    ChatServer @relation(fields: [serverId], references: [id], onDelete: Cascade)
  serverId  String
  
  invitedUser   User   @relation("InvitedUser", fields: [invitedUserId], references: [id])
  invitedUserId String
  
  invitedBy   User   @relation("InvitedBy", fields: [invitedById], references: [id])
  invitedById String
  
  status    InvitationStatus @default(PENDING)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([serverId])
  @@index([invitedUserId])
  @@unique([serverId, invitedUserId])
}

model ServerMember {
  id       String     @id @default(cuid())
  server   ChatServer @relation(fields: [serverId], references: [id], onDelete: Cascade)
  serverId String
  user     User       @relation(fields: [userId], references: [id])
  userId   String
  role     MemberRole @default(MEMBER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([serverId, userId])
}

model Channel {
  id          String      @id @default(cuid())
  name        String
  type        ChannelType
  description String?
  server      ChatServer  @relation(fields: [serverId], references: [id], onDelete: Cascade)
  serverId    String
  messages    Message[]
  recordings  Recording[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([serverId, name])
}

model Message {
  id        String      @id @default(cuid())
  content   String      @db.Text
  type      MessageType @default(TEXT)
  author    User        @relation(fields: [authorId], references: [id])
  authorId  String
  channel   Channel     @relation(fields: [channelId], references: [id], onDelete: Cascade)
  channelId String
  files     File[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model File {
  id        String   @id @default(cuid())
  name      String
  url       String
  type      FileType
  size      Int
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Recording {
  id          String  @id @default(cuid())
  title       String
  description String?
  url         String
  duration    Int // Duration in seconds
  thumbnail   String?
  channel     Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  channelId   String
  recorder    User    @relation(fields: [recorderId], references: [id])
  recorderId  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum MessageType {
  TEXT
  FILE
  SYSTEM
}

enum FileType {
  IMAGE
  DOCUMENT
  VIDEO
  AUDIO
}

enum UserRole {
  ADMIN
  MENTOR
  MENTEE
}

enum ConnectionStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum ReactionType {
  LIKE
  HEART
  HAHA
  SAD
  CONGRATS
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum ChannelType {
  TEXT
  VOICE
  VIDEO
  STREAMING
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
}
