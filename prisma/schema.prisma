// 1. Cấu hình Generator và Datasource
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

// LƯU Ý: Đã xóa toàn bộ enum vì SQL Server không hỗ trợ Prisma Enum.
// Thay vào đó, chúng ta dùng String.

// 2. Định nghĩa Models

model User {
  id            String   @id @default(dbgenerated()) @db.VarChar(20)
  name          String?  @db.NVarChar(100)
  email         String   @unique @db.NVarChar(100)
  accountStatus String?  @default("Active") @map("account_status") @db.NVarChar(20)
  // Đổi Enum thành String
  userType      String   @default("MENTEE") @map("user_type") @db.VarChar(10) 
  department    String?  @db.NVarChar(100)
  major         String?  @db.NVarChar(100)
  createdAt     DateTime @default(now()) @db.DateTime2
  updatedAt     DateTime @default(now()) @updatedAt @db.DateTime2

  // Quan hệ
  mentorProfile       MentorProfile?
  menteeConnections   MenteeConnection[] @relation("MenteeRel")
  mentorConnections   MenteeConnection[] @relation("MentorRel")
  createdEvents       CalendarEvent[]    @relation("EventCreator")
  eventAssignments    EventAssignment[]
  notifications       Notification[]
  progressRecords     ProgressRecord[]
  reports             ReportsView[]
  posts               Post[]
  comments            Comment[]
  reactions           Reaction[]
  reviewsGiven        Review[]           @relation("ReviewerRel")
  reviewsReceived     Review[]           @relation("MentorReviewRel")
  feedbackGiven       MentorFeedback[]   @relation("FeedbackMentorRel")
  feedbackReceived    MentorFeedback[]   @relation("FeedbackMenteeRel")
  ownedServers        ChatServer[]
  serverInvitations   ServerInvitation[] @relation("InvitedUser")
  sentInvitations     ServerInvitation[] @relation("Inviter")
  serverMemberships   ServerMember[]
  messages            Message[]
  chatConversations   ChatConversation[]
  recordings          Recording[]

  @@map("User")
}

model MentorProfile {
  id           String   @id @default(dbgenerated()) @db.VarChar(20)
  userId       String   @unique @db.VarChar(20)
  rating       Decimal  @default(0.00) @db.Decimal(3, 2)
  totalReviews Int      @default(0)
  createdAt    DateTime @default(now()) @db.DateTime2
  updatedAt    DateTime @default(now()) @updatedAt @db.DateTime2

  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  chuyenMon ChuyenMon[]
  lichTrong LichTrong[]
}

model ChuyenMon {
  mentorId String @map("mentor_id") @db.VarChar(20)
  bangCap  String @map("bang_cap") @db.NVarChar(255)

  mentor MentorProfile @relation(fields: [mentorId], references: [id], onDelete: Cascade)

  @@id([mentorId, bangCap])
  @@map("ChuyenMon")
}

model LichTrong {
  maLichTrong Int      @id @default(autoincrement()) @map("ma_lich_trong")
  mentorId    String   @map("mentor_id") @db.VarChar(20)
  ngay        DateTime @db.Date
  gioBatDau   DateTime @map("gio_bat_dau") @db.Time
  gioKetThuc  DateTime @map("gio_ket_thuc") @db.Time

  mentor MentorProfile @relation(fields: [mentorId], references: [id], onDelete: Cascade)

  @@map("LichTrong")
}

model MenteeConnection {
  id        String   @id @default(dbgenerated()) @db.VarChar(20)
  menteeId  String   @db.VarChar(20)
  mentorId  String   @db.VarChar(20)
  // Đổi Enum thành String
  status    String   @default("PENDING") @db.VarChar(20) 
  createdAt DateTime @default(now()) @db.DateTime2
  updatedAt DateTime @default(now()) @updatedAt @db.DateTime2

  mentee User @relation("MenteeRel", fields: [menteeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  mentor User @relation("MentorRel", fields: [mentorId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([menteeId, mentorId])
}

model CalendarEvent {
  id          String   @id @default(dbgenerated()) @db.VarChar(20)
  title       String   @db.NVarChar(255)
  description String?  @db.NVarChar(Max)
  startTime   DateTime @db.DateTime2
  endTime     DateTime @db.DateTime2
  // Đổi Enum thành String
  priority    String   @default("MEDIUM") @db.VarChar(20)
  isCompleted Boolean  @default(false)
  creatorId   String   @db.VarChar(20)
  createdAt   DateTime @default(now()) @db.DateTime2
  updatedAt   DateTime @default(now()) @updatedAt @db.DateTime2

  creator     User              @relation("EventCreator", fields: [creatorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  assignments EventAssignment[]
  reminders   EventReminder[]
}

model EventAssignment {
  id        String   @id @default(dbgenerated()) @db.VarChar(20)
  eventId   String   @db.VarChar(20)
  userId    String   @db.VarChar(20)
  // Đổi Enum thành String
  status    String   @default("PENDING") @db.VarChar(20)
  createdAt DateTime @default(now()) @db.DateTime2
  updatedAt DateTime @default(now()) @updatedAt @db.DateTime2

  event    User          @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  calEvent CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
}

model EventReminder {
  id           String   @id @default(dbgenerated()) @db.VarChar(20)
  eventId      String   @db.VarChar(20)
  reminderTime DateTime @db.DateTime2
  message      String?  @db.NVarChar(255)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now()) @db.DateTime2
  updatedAt    DateTime @default(now()) @updatedAt @db.DateTime2

  event CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String   @id @default(dbgenerated()) @db.VarChar(20)
  title     String   @db.NVarChar(255)
  content   String   @db.NVarChar(Max)
  isRead    Boolean  @default(false)
  userId    String   @db.VarChar(20)
  createdAt DateTime @default(now()) @db.DateTime2
  updatedAt DateTime @default(now()) @updatedAt @db.DateTime2

  user User @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model ProgressRecord {
  id        String   @id @default(dbgenerated()) @db.VarChar(20)
  menteeId  String   @db.VarChar(20)
  score     Decimal  @db.Decimal(5, 2)
  notes     String?  @db.NVarChar(Max)
  createdAt DateTime @default(now()) @db.DateTime2
  updatedAt DateTime @default(now()) @updatedAt @db.DateTime2

  mentee User @relation(fields: [menteeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model ReportsView {
  id          String   @id @default(dbgenerated()) @db.VarChar(20)
  userId      String   @db.VarChar(20)
  title       String   @db.NVarChar(255)
  description String?  @db.NVarChar(1023)
  visibility  String?  @default("Private") @db.NVarChar(20)
  createdAt   DateTime @default(now()) @db.DateTime2
  updatedAt   DateTime @default(now()) @updatedAt @db.DateTime2

  user User @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model Post {
  id        String   @id @default(dbgenerated()) @db.VarChar(20)
  content   String   @db.NVarChar(Max)
  authorId  String   @db.VarChar(20)
  createdAt DateTime @default(now()) @db.DateTime2
  updatedAt DateTime @default(now()) @updatedAt @db.DateTime2

  author    User       @relation(fields: [authorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  images    Images[]
  comments  Comment[]
  reactions Reaction[]
}

model Images {
  id       String @id @default(dbgenerated()) @db.VarChar(20)
  postId   String @map("post_id") @db.VarChar(20)
  imageUrl String @map("image_url") @db.NVarChar(255)

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@map("Images")
}

model Comment {
  id        String   @id @default(dbgenerated()) @db.VarChar(20)
  content   String   @db.NVarChar(Max)
  postId    String   @db.VarChar(20)
  authorId  String   @db.VarChar(20)
  createdAt DateTime @default(now()) @db.DateTime2

  post   Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model Reaction {
  id        String   @id @default(dbgenerated()) @db.VarChar(20)
  // Đổi Enum thành String
  type      String   @db.VarChar(20)
  postId    String   @db.VarChar(20)
  userId    String   @db.VarChar(20)
  createdAt DateTime @default(now()) @db.DateTime2

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([postId, userId])
}

model Review {
  id         String   @id @default(dbgenerated()) @db.VarChar(20)
  reviewerId String   @db.VarChar(20)
  mentorId   String   @db.VarChar(20)
  rating     Int
  comment    String?  @db.NVarChar(Max)
  createdAt  DateTime @default(now()) @db.DateTime2

  reviewer User @relation("ReviewerRel", fields: [reviewerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  mentor   User @relation("MentorReviewRel", fields: [mentorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model MentorFeedback {
  id        String   @id @default(dbgenerated()) @db.VarChar(20)
  mentorId  String   @db.VarChar(20)
  menteeId  String   @db.VarChar(20)
  score     Int?
  comment   String?  @db.NVarChar(Max)
  createdAt DateTime @default(now()) @db.DateTime2

  mentor User @relation("FeedbackMentorRel", fields: [mentorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  mentee User @relation("FeedbackMenteeRel", fields: [menteeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model ChatServer {
  id          String   @id @default(dbgenerated()) @db.VarChar(20)
  name        String   @db.NVarChar(100)
  description String?  @db.NVarChar(Max)
  image       String?  @db.NVarChar(500)
  ownerId     String   @db.VarChar(20)
  createdAt   DateTime @default(now()) @db.DateTime2
  updatedAt   DateTime @default(now()) @updatedAt @db.DateTime2

  owner       User               @relation(fields: [ownerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  invitations ServerInvitation[]
  members     ServerMember[]
  channels    Channel[]
}

model ServerInvitation {
  id            String   @id @default(dbgenerated()) @db.VarChar(20)
  serverId      String   @db.VarChar(20)
  invitedUserId String   @db.VarChar(20)
  invitedById   String   @db.VarChar(20)
  // Đổi Enum thành String
  status        String   @default("PENDING") @db.VarChar(20)
  createdAt     DateTime @default(now()) @db.DateTime2
  updatedAt     DateTime @default(now()) @updatedAt @db.DateTime2

  server      ChatServer @relation(fields: [serverId], references: [id], onDelete: Cascade)
  invitedUser User       @relation("InvitedUser", fields: [invitedUserId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  inviter     User       @relation("Inviter", fields: [invitedById], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([serverId, invitedUserId])
}

model ServerMember {
  id        String   @id @default(dbgenerated()) @db.VarChar(20)
  serverId  String   @db.VarChar(20)
  userId    String   @db.VarChar(20)
  // Đổi Enum thành String
  role      String   @default("MEMBER") @db.VarChar(20)
  createdAt DateTime @default(now()) @db.DateTime2
  updatedAt DateTime @default(now()) @updatedAt @db.DateTime2

  server ChatServer @relation(fields: [serverId], references: [id], onDelete: Cascade)
  user   User       @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([serverId, userId])
}

model Channel {
  id          String   @id @default(dbgenerated()) @db.VarChar(20)
  name        String   @db.NVarChar(100)
  description String?  @db.NVarChar(Max)
  serverId    String   @db.VarChar(20)
  createdAt   DateTime @default(now()) @db.DateTime2
  updatedAt   DateTime @default(now()) @updatedAt @db.DateTime2

  server     ChatServer  @relation(fields: [serverId], references: [id], onDelete: Cascade)
  messages   Message[]
  recordings Recording[]

  @@unique([serverId, name])
}

model Message {
  id        String   @id @default(dbgenerated()) @db.VarChar(20)
  content   String?  @db.NVarChar(Max)
  authorId  String   @db.VarChar(20)
  channelId String   @db.VarChar(20)
  createdAt DateTime @default(now()) @db.DateTime2
  updatedAt DateTime @default(now()) @updatedAt @db.DateTime2

  author  User   @relation(fields: [authorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  files   File[]
}

model File {
  id        String   @id @default(dbgenerated()) @db.VarChar(20)
  name      String   @db.NVarChar(255)
  url       String   @db.NVarChar(500)
  size      BigInt
  messageId String   @db.VarChar(20)
  createdAt DateTime @default(now()) @db.DateTime2
  updatedAt DateTime @default(now()) @updatedAt @db.DateTime2

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@map("File")
}

model ChatConversation {
  id        String   @id @default(dbgenerated()) @db.VarChar(20)
  userId    String   @db.VarChar(20)
  title     String?  @db.NVarChar(255)
  createdAt DateTime @default(now()) @db.DateTime2
  updatedAt DateTime @default(now()) @updatedAt @db.DateTime2

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]
}

model ChatMessage {
  id             String   @id @default(dbgenerated()) @db.VarChar(20)
  conversationId String   @db.VarChar(20)
  content        String   @db.NVarChar(Max)
  createdAt      DateTime @default(now()) @db.DateTime2

  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model Recording {
  id          String   @id @default(dbgenerated()) @db.VarChar(20)
  description String?  @db.NVarChar(Max)
  duration    Int
  channelId   String   @db.VarChar(20)
  recorderId  String   @db.VarChar(20)
  createdAt   DateTime @default(now()) @db.DateTime2
  updatedAt   DateTime @default(now()) @updatedAt @db.DateTime2

  channel  Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  recorder User    @relation(fields: [recorderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}